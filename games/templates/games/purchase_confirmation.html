{% extends 'games/base.html' %}
{% load static %}

{% block title %}Confirmação de Compra - Retro Games Cloud{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8 col-md-10">
        <!-- Cabeçalho de Sucesso -->
        <div class="modern-card text-center mb-4">
            <div class="success-animation mb-3">
                <i class="fas fa-check-circle fa-5x text-success"></i>
            </div>
            <h1 class="retro-title text-success">
                {% if is_plan %}
                    Assinatura Ativada com Sucesso!
                {% else %}
                    Compra Realizada com Sucesso!
                {% endif %}
            </h1>
            <p class="retro-subtitle">
                {% if is_plan %}
                    Sua assinatura foi ativada e você já tem acesso aos jogos do plano.
                {% else %}
                    Seu jogo foi comprado e você já tem acesso a ele.
                {% endif %}
            </p>
        </div>

        <!-- Informações do Item -->
        <div class="modern-card mb-4">
            <h3 class="retro-heading mb-3">
                <i class="fas fa-shopping-bag me-2"></i>Item Adquirido
            </h3>
            <div class="row">
                <div class="col-md-3">
                    {% if session.game %}
                    <div class="game-image-modern" style="background-image: url('{{ session.game.cover_image }}'); height: 150px; border-radius: 12px;"></div>
                    {% else %}
                    <div class="text-center">
                        <i class="fas fa-crown fa-4x text-gradient"></i>
                    </div>
                    {% endif %}
                </div>
                <div class="col-md-9">
                    <h4 class="retro-heading">
                        {% if session.game %}
                            {{ session.game.title }}
                        {% else %}
                            {{ session.plan.name }}
                        {% endif %}
                    </h4>
                    <p class="retro-text">
                        {% if session.game %}
                            <span class="game-console-modern">{{ session.game.console }}</span>
                        {% else %}
                            <span class="modern-badge modern-badge-warning">Plano de Assinatura</span>
                        {% endif %}
                    </p>
                    <p class="retro-text">
                        {% if session.game %}
                            {{ session.game.description }}
                        {% else %}
                            {{ session.plan.description }}
                        {% endif %}
                    </p>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="modern-badge modern-badge-success fs-5">
                            <i class="fas fa-dollar-sign me-1"></i>R$ {{ session.amount }}
                        </span>
                        <small class="text-muted">
                            <i class="fas fa-calendar me-1"></i>{{ session.completed_at|date:"d/m/Y H:i" }}
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tokens de Acesso -->
        {% if tokens %}
        <div class="modern-card mb-4">
            <h3 class="retro-heading mb-3">
                <i class="fas fa-key me-2"></i>Tokens de Acesso
            </h3>
            <p class="retro-text mb-4">
                {% if is_plan %}
                    Você recebeu tokens de acesso para todos os jogos do plano. Use estes tokens para acessar os jogos:
                {% else %}
                    Você recebeu um token de acesso para o jogo. Use este token para acessar o jogo:
                {% endif %}
            </p>
            
            {% for token_data in tokens %}
            <div class="token-card mb-3">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h5 class="retro-heading mb-1">{{ token_data.game.title }}</h5>
                        <span class="game-console-modern">{{ token_data.game.console }}</span>
                    </div>
                    <div class="col-md-6">
                        <div class="input-group">
                            <input type="text" 
                                   class="form-control font-monospace" 
                                   value="{{ token_data.token.token }}" 
                                   id="token-{{ forloop.counter }}" 
                                   readonly>
                            <button class="modern-btn modern-btn-secondary" 
                                    type="button" 
                                    onclick="copyToken('token-{{ forloop.counter }}')">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Token válido até: {{ token_data.token.expires_at|date:"d/m/Y H:i"|default:"Nunca" }}
                        </small>
                    </div>
                </div>
            </div>
            {% endfor %}
            
            <div class="modern-alert modern-alert-info">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Como usar:</strong> Copie o token e use-o na aplicação do jogo ou via API para validar seu acesso.
            </div>
        </div>
        {% endif %}

        <!-- Informações Adicionais -->
        <div class="row">
            <div class="col-md-6">
                <div class="modern-card">
                    <h4 class="retro-heading mb-3">
                        <i class="fas fa-info-circle me-2"></i>Informações da Compra
                    </h4>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="retro-text">ID da Sessão:</span>
                        <span class="font-monospace small">{{ session.session_id }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="retro-text">Data da Compra:</span>
                        <span class="retro-text">{{ session.completed_at|date:"d/m/Y H:i" }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="retro-text">Status:</span>
                        <span class="modern-badge modern-badge-success">Concluída</span>
                    </div>
                    {% if is_plan %}
                    <div class="d-flex justify-content-between">
                        <span class="retro-text">Tipo:</span>
                        <span class="retro-text">Assinatura Mensal</span>
                    </div>
                    {% else %}
                    <div class="d-flex justify-content-between">
                        <span class="retro-text">Tipo:</span>
                        <span class="retro-text">Compra Individual</span>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="modern-card">
                    <h4 class="retro-heading mb-3">
                        <i class="fas fa-question-circle me-2"></i>Próximos Passos
                    </h4>
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            {% if is_plan %}
                                Acesse sua biblioteca para ver todos os jogos disponíveis
                            {% else %}
                                Acesse sua biblioteca para ver o jogo comprado
                            {% endif %}
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-key text-primary me-2"></i>
                            Use os tokens fornecidos para acessar os jogos
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-gamepad text-info me-2"></i>
                            Divirta-se jogando!
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Botões de Ação -->
        <div class="text-center mt-4">
            <div class="d-flex gap-3 justify-content-center flex-wrap">
                <a href="{% url 'library' %}" class="modern-btn modern-btn-primary">
                    <i class="fas fa-book me-2"></i>Ver Minha Biblioteca
                </a>
                <a href="{% url 'home' %}" class="modern-btn modern-btn-secondary">
                    <i class="fas fa-home me-2"></i>Voltar ao Início
                </a>
            </div>
        </div>

        <!-- Aviso sobre Simulação -->
        <div class="modern-alert modern-alert-warning mt-4">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Nota:</strong> Esta é uma simulação de compra para fins de teste. 
            Nenhum valor real foi cobrado e os tokens são válidos apenas para demonstração.
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.success-animation {
    animation: bounceIn 1s ease-out;
}

.token-card {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border: 1px solid #dee2e6;
    border-radius: 12px;
    padding: 1rem;
    transition: all 0.3s ease;
}

.token-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

@keyframes bounceIn {
    0% {
        opacity: 0;
        transform: scale(0.3);
    }
    50% {
        opacity: 1;
        transform: scale(1.05);
    }
    70% {
        transform: scale(0.9);
    }
    100% {
        opacity: 1;
        transform: scale(1);
    }
}

.font-monospace {
    font-family: 'JetBrains Mono', monospace !important;
}

.input-group .form-control {
    border-radius: 8px 0 0 8px;
}

.input-group .btn {
    border-radius: 0 8px 8px 0;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Animação de entrada
    const cards = document.querySelectorAll('.modern-card');
    cards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(30px)';
        setTimeout(() => {
            card.style.transition = 'all 0.6s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 200);
    });
    
    // Efeito de digitação no título
    const title = document.querySelector('.retro-title');
    if (title) {
        const text = title.textContent;
        title.textContent = '';
        let i = 0;
        const typeWriter = () => {
            if (i < text.length) {
                title.textContent += text.charAt(i);
                i++;
                setTimeout(typeWriter, 80);
            }
        };
        setTimeout(typeWriter, 300);
    }
    
    // Efeito pulsante no ícone de sucesso
    const successIcon = document.querySelector('.success-animation i');
    if (successIcon) {
        setInterval(() => {
            successIcon.style.transform = 'scale(1.1)';
            setTimeout(() => {
                successIcon.style.transform = 'scale(1)';
            }, 300);
        }, 3000);
    }
});

// Função para copiar token
function copyToken(inputId) {
    const input = document.getElementById(inputId);
    input.select();
    input.setSelectionRange(0, 99999); // Para mobile
    
    try {
        document.execCommand('copy');
        
        // Feedback visual
        const button = input.nextElementSibling;
        const originalHTML = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check"></i>';
        button.classList.remove('modern-btn-secondary');
        button.classList.add('modern-btn-success');
        
        setTimeout(() => {
            button.innerHTML = originalHTML;
            button.classList.remove('modern-btn-success');
            button.classList.add('modern-btn-secondary');
        }, 2000);
        
        // Mostrar toast de sucesso
        showToast('Token copiado com sucesso!', 'success');
    } catch (err) {
        showToast('Erro ao copiar token', 'error');
    }
}

// Função para mostrar toast
function showToast(message, type) {
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-${type === 'success' ? 'check' : 'exclamation-triangle'} me-2"></i>
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    // Adicionar ao container de toasts (criar se não existir)
    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        toastContainer.style.zIndex = '1055';
        document.body.appendChild(toastContainer);
    }
    
    toastContainer.appendChild(toast);
    
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    // Remover o toast após ser escondido
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}
</script>
{% endblock %}
